package org.ps5jb.client.payloads.umtx.impl2;

import org.ps5jb.client.payloads.umtx.common.DebugStatus;
import org.ps5jb.client.payloads.umtx.common.LoggingConfiguration;
import org.ps5jb.loader.Status;
import org.ps5jb.sdk.lib.LibKernel;

public class UmtxExploit implements Runnable {
    @Override
    public void run() {
        LoggingConfiguration loggingUi = LoggingConfiguration.createComponent();
        if (!loggingUi.render()) {
            DebugStatus.error("UMTX execution aborted");
            return;
        }

        // It seems more stable to run the exploit in a separate thread on a separate core and wait
        try {
            LibKernel libKernel = new LibKernel();
            UmtxExploitJob.pinToCoreSelf(0, libKernel);
            UmtxExploitJob.setRtprioSelf((short) 767, libKernel);

            UmtxExploitJob umtxJob = new UmtxExploitJob();
            Thread thread = new Thread(umtxJob, "UMTX Main");
            thread.start();

            while (!umtxJob.finished) {
                try {
                    Thread.sleep(2000L);
                } catch (InterruptedException e) {
                    // Ignore
                }
            }
        } catch (RuntimeException | Error e) {
            DebugStatus.error("UMTX execution failure", e);
        }
    }
}
